# Mobile Services Docs QA Library

[![Build
Status](https://prod-build10300.wdf.sap.corp/job/default_1/job/d053411-cpmscf-docs-lib-main-CI-linuxx86_64/badge/icon)](https://prod-build10300.wdf.sap.corp:443/job/default_1/job/d053411-cpmscf-docs-lib-main-CI-linuxx86_64/)

## Important Links

* [:shipit: Milestone Build](https://prod-build10300.wdf.sap.corp/job/default_1/job/d053411-cpmscf-docs-lib-OD-common/lastCompletedBuild/rebuild/parameterized)
* [Releases](http://nexus3.wdf.sap.corp:8081/nexus/#browse/search=keyword%3Dmdlib)
* [MoMa](https://moma.mo.sap.corp/#/apps/10440)
* [Project Portal](https://projectportal.tools.sap/#/projectview/d053411-cpmscf-docs-lib)
* [NAAS](https://github.wdf.sap.corp/NAAS-Mobile/cpmscf-docs-lib)
* [Jenkins Jobs](https://xmake-nova.wdf.sap.corp/job_finder/?input=d053411-cpmscf-docs-lib)

## Configuration

Configuration can easily be done via a `.cdcrc` file in the project root. See [config.ts](./src/config.ts) and [dita.ts](./src/dita/dita.ts) for the schema, or refer to the table below. See also the [configuration in CPMSCF/docs](https://github.wdf.sap.corp/CPMSCF/docs/blob/master/.cdcrc) for an advanced config example, or refer to the test cases.

|Option|Default|Description|
|------|-------|-----------|
|`path`|`process.cwd()`|Path to the documentation root, relative to the current working directory.|
|`config`|`"mkdocs.yml"`|Path to the MkDocs config file, relative to `path`. Can point to folders outside `path` e.g. by specifying `../sibling-folder`.|
|`ignore`|`[]`|List of paths to ignore when running commands in [`@cpmscf/mdcli`](https://github.wdf.sap.corp/D053411/cpmscf-docs-cli). `**/*` will be appended to each of those paths so that it can be used as glob exclusion pattern. Does not have any effect in the library itself.|
|`profiles`|`{configurations: []}`|Profile configurations for advanced link checking. See [Profiling in CPMSCF/docs](https://github.wdf.sap.corp/CPMSCF/docs/blob/master/TUTORIAL.md#profiling) and [`rule-profile.ts`](./src/lint-plugin/rule-profile.ts)|
|`dita`|(see below)|DITA-related configuration for DITA upload ZIPs. See also additional notes in (#controlling-dita-page-metadata)|
|`dita.outputPath`|`process.cwd()`|Output path for generated ZIP file|
|`dita.includePatterns`|`["**/*.{png,svg,jpg,jpeg,gif}"]`|Glob patterns for files to be included in the output ZIP that are not listed in the table of contents|
|`dita.excludePatterns`|`[]`|Glob patterns for files to be excluded in the output ZIP. Will also be applied to filter the table of contents. This should be used for external and generated files, if any.|
|`dita.pretty`|`false`|Pretty-print `schema.xml`|
|`dita.editBase`|`undefined`|Base URL that is prepended to file HREFs to generate edit links for pages. For instance, to generate the edit link `https://git.org/org/repo/blob/main/docs/file.md`, where `docs/file.md` is the file HREF relative to the archive root, set this to `https://git.org/org/repo/blob/main`.|
|`dita.frameworkPlugin`|Internal MkDocs-support|Alternative strategy to discover and parse framework-related info, such as the table of contents and other metadata. Can refer to dependencies pulled from `npm` (e.g. `npm install my-framework-plugin`, where `my-framework-plugin` becomes the `frameworkPlugin` config value) or to local files (relative to the current working directory), e.g. `./myPlugin` for `myPlugin.js`. In either case, the plugin needs to be the default export of the module and implement the `FrameworkPlugin` interface defined in [`plugin.ts`](./src/dita/plugin.ts). See [Other Framework Support](#other-framework-support) for a sample implementation.|
|`dita.project`|`undefined`|Contains `name`, `coordinator` and `format` (should be `markdown`). Must be supplied when using the DITA converter. See [`example.xml`](./test/dita/example.xml) for examples provided by the UA team.|
|`dita.deliverable`|`undefined`|Contains `label`, `language`, `loio`, `rootfile`, `shortdesc`, `transtype`, `version`, `owner`, `outputmetas`. `buildname` will be (1) pulled from the system environment variable `BUILD_NUMBER`, which by default is available in XMake jobs; (2) from `dita.deliverable.buildname` if present; and (3) otherwise be set to `"0"`. See [`example.xml`](./test/dita/example.xml) for examples provided by the UA team.|
|`upload.auth`|`undefined`|Base-64 encoded `username:password` value to be sent to the UACP ZIP upload service for authentication.|
|`mkdocs.validateFiles`|`false`|Check if all Markdown files in the project directory are referenced in `mkdocs.yml`|
|`mkdocs.headingCase`|`true`|Check topic heads and alternative topic titles in `mkdocs.yml` are in title case|
|`mkdocs.terms`|`[]`|List of inappropriate term checks. See example in [tests](test/terms/index.test.ts#L16).|
|`mkdocs.terms[].match`|Required (`string`)|Match occurrences of this pattern in Markdown code. You may use regular expressions, but JSON escaping for special characters (e.g. backslash) applies. The pattern will be modified so that it applies regardless of spaces and does not match parts of words, i.e. `two words` becomes `\btwo\s+words\b`.|
|`mkdocs.terms[].replace`|Required (`string[]`)|List of replacements proposed to users. If multiple are given, auto fixes apply the first item in the list.|
|`mkdocs.terms[].includeNodes`|`[]`|Optional node types to which matching should be limited. Defaults to empty array, matching all text nodes. Currently supported: `heading`, `paragraph`, `blockquote`, `list`, `listItem`, `inlineCode`, `code`, `html`, `strong`, `emphasis`, `delete`, `link`, `linkReference`, `imageReference`, `definition`, `image`, `footnote`, `footnoteReference`, `footnoteDefinition`, `table`, `tableCell`|
|`mkdocs.terms[].excludeNodes`|`[]`|See `mkdocs.terms[].includeNodes`, but functions as a deny list. Only one of them can be active at any time; if `excludeNodes` is defined, `includeNodes` will be ignored.|
|`mkdocs.terms[].comment`|`undefined`|Optional explanatory comment both to document the replacement in code, and to give additional information to end users when the rule is triggered.|
|`translation`|`undefined`|Optional configuration to generate `translation_v2.json` for the SAP-internal translation service. Translation file mappings can either be statically specified or generated by means of profiling. See [the tutorial](https://jam4.sapjam.com/groups/RfzzEoLStZNjxuKhM6swuF/documents/mLymfCk5nHlHNQDGTnjdkY/slide_viewer) to learn about the `translation_v2.json` file format. Example output can be found [in the tests](test/translation/index.test.ts#L25).|
|`translation.template`|`undefined`|Optional default values to copy over to the generated file. If all content is static, this may contain your full `translation_v2.json` content. Otherwise, it is a good place to put `defaultConfiguration`. See example in [tests](test/translation/.cdcrc#L35).|
|`translation.collections`|`undefined`|Optional list of collections to render in the output file. Can be used interchangibly with `defaultConfiguration.collections` if all content is static. Note that this property overrides `translation.template.collections`, so you cannot set both.|
|`translation.collections[].collectionName`|Required (`string`)|Name of the collection, just as in the resulting `translation_v2.json` file.|
|`translation.collections[].folders`|[]|List of folder definitions as per `translation_v2.json` schema. Note limitations in `translation.collections[].profile`.|
|`translation.collections[].profile`|[]|Name of profile that should be used to narrow down what files should be translated. All files matching `translation.collections[].includePattern` will be added to `sourceFilters`, except those matching `profile.excludes`. Note that `folders` may have at most one item when this setting is used. Any `sourceFilters` specified in `translation.collections[].folders` will be appended. File paths in `sourceFilters` will be relative to `translation.collections[].folders[0].startingFolderPath`, if specified, and to the current working directory otherwise. See example in [tests](test/translation/index.test.ts#L15).|
|`translation.collections[].includePattern`|`**/*.{markdown,md,yml}`|Pattern matching files to include in the `sourceFilters` list.|

### Controlling DITA Page Metadata

Topic refs generated in UACP `metadata.xml` may have additional properties that are not inherently supported by Markdown. Take the following ref, for instance:

```xml
<topicref label="Short descriptions" type="task" author="jens.haley@sap.com" lastmodifiedby="jens.haley@sap.com" lastmodified="2020-11-12 11:17:35 +0100" href="20-doc-structure/short-descriptions.md"/>
```

1. The `label` is, in order, taken from
    1. The YAML Frontmatter `title`, i.e.

    ```markdown
    ---
    title: Short descriptions
    ---

    ...
    ```

    1. The first level 1 heading in the document, i.e.

    ```markdown
    # Short descriptions

    ...
    ```

    1. The file name, i.e.

    ```nohighlight
    short-descriptions.md
    ```

    For that purpose,

      1. The file stem (file name without extension) is taken: `short-descriptions`
      1. Non-whitespace characters are stripped: `short descriptions`
      1. The resulting string is converted to title case: `Short Descriptions`

1. The `type` property can be controlled in Frontmatter by adding a `dita.type` entry:

    ```markdown
    ---
    dita.type: task
    ---
    ```

    Unless specified, the `dita.type` defaults to `concept`.

## Other Framework Support

The majority of this library is tailored towards the CPMSCF/docs project, which is built with MkDocs and additional customizations. However, the DITA support should be easy enough to extent to other projects. Refer to the `dita.frameworkPlugin` option above and provide a plugin that reads, at the very least, the nav tree of your docs framework and returns it. See [`lib.ts`](./src/lib.ts#L9) for the schema. Below is the most basic possible implementation returning a static nav tree:

```ts
export default function myPlugin () => {
    return [
        "index.md", // Simple link to a file. Title will be parsed from markdown (h1 or frontmatter)
        {
            "Overview": [ // Topic head
                "overview.md", // Simple link within topic head
                {"Custom Title": "docs/notitle.md"}, // Link with alternative title "Custom Title"
            ]
        },
    ];
};
```
